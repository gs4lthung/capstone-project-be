@startuml learner-progress-achievement

title Learner Progress Tracking & Achievement

actor Learner
participant "Frontend\nApp" as Frontend
participant "API\nGateway" as API
participant "LearnerProgress\nService" as ProgressSvc
participant "Achievement\nService" as AchievementSvc
participant "AchievementTracking\nService" as TrackingSvc
participant "Notification\nService" as NotifSvc
participant "Database" as DB

== Lesson Completion Trigger ==

Frontend -> API: POST /lessons/{lessonId}/mark-complete
API -> ProgressSvc: MarkLessonComplete(learnerId, lessonId)
ProgressSvc -> DB: Get LearnerProgress for lesson
DB --> ProgressSvc: Progress record

ProgressSvc -> ProgressSvc: Check all activities completed\n(quiz=done, video=submitted)

alt All Activities Completed
    ProgressSvc -> DB: Update LearnerProgress\n(status=COMPLETED, completedAt=now)
    DB --> ProgressSvc: Progress updated
    
    ProgressSvc -> DB: Query Lesson metadata\n(courseId, order)
    DB --> ProgressSvc: Lesson data
    
    == Check Course Completion ==
    ProgressSvc -> DB: Get all lessons in course\nCount completed lessons
    DB --> ProgressSvc: Lesson count + completion status
    
    alt All Course Lessons Done
        ProgressSvc -> DB: Update Enrollment\n(status=COMPLETED, completedAt=now)
        DB --> ProgressSvc: Enrollment marked complete
        ProgressSvc -> TrackingSvc: CourseCompletionEvent\n(learnerId, courseId)
    else Lessons Remaining
        ProgressSvc -> TrackingSvc: LessonCompletionEvent\n(learnerId, courseId)
    end
else Missing Activities
    ProgressSvc --> API: Error - incomplete activities
    API --> Frontend: Show what's missing
    Frontend --> Learner: "Complete all activities first"
end

== Achievement Evaluation ==
ProgressSvc -> AchievementSvc: EvaluateAchievements\n(learnerId, courseId, event)

AchievementSvc -> DB: Get learner completed lessons count
DB --> AchievementSvc: Count

AchievementSvc -> AchievementSvc: Evaluate achievement criteria

== Achievement Award ==
loop For each applicable achievement
    AchievementSvc -> DB: Check if already unlocked\n(LearnerAchievement exists)
    
    alt Not Yet Unlocked
        AchievementSvc -> DB: Create LearnerAchievement\n(learnerId, achievementId, unlockedAt=now)
        DB --> AchievementSvc: Achievement created
        AchievementSvc -> AchievementSvc: Prepare achievement data\n(icon, name, description, points)
        
        alt Achievement Type = CERTIFICATE
            AchievementSvc -> AchievementSvc: Generate certificate\n(learnerId, courseId, issueDate)
        else Other Achievement
            AchievementSvc -> AchievementSvc: Standard achievement
        end
        
        AchievementSvc -> TrackingSvc: LogAchievementUnlock\n(learnerId, achievementId)
        
    else Already Unlocked
        AchievementSvc -> AchievementSvc: Skip (already has)
    end
end

== Notification & Display ==
AchievementSvc -> NotifSvc: SendNotifications\n(learnerId, achievements[])
NotifSvc -> DB: Log achievements notification
DB --> NotifSvc: Logged
NotifSvc --> NotifSvc: Send push/email notifications

AchievementSvc --> ProgressSvc: Achievements list\n(newAchievements[], totalPoints)

== Update Learner State ==
ProgressSvc -> DB: Update learner achievement points\n(LearnerAchievement aggregation)
DB --> ProgressSvc: Points updated

alt Course Completed
    ProgressSvc -> DB: Mark course completed\n(Enrollment status=COMPLETED)
    ProgressSvc -> TrackingSvc: CourseCompletedEvent\n(learnerId, courseId)
    TrackingSvc -> NotifSvc: Send congratulations\n(course completion)
    NotifSvc --> NotifSvc: Notify completion
end

== Return Results ==
ProgressSvc --> API: Progress update + achievements
API --> Frontend: Response:
API --> Frontend: Display results
Frontend --> Learner: Show celebration screen:\n- Lesson completed!\n- New achievements unlocked!\n- Show achievement details\n- Display progress bar\n- Next lesson suggestion


@enduml

