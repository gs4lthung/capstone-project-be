@startuml

actor "Guest" as guest
participant "Client" as client
participant "Coach\nController" as controller
participant "Coach\nService" as service
participant "Mail\nService" as mail
participant "Twilio\nService" as twilio
database "Database" as db

guest -> client: 1. Fill coach registration form
client -> controller: 2. POST /coaches/register\n{fullName, email, phoneNumber,\npassword, province, district,\nbio, specialties, teachingMethods,\nyearOfExperience}
activate controller

controller -> service: 3. registerCoach({fullName, email,\nphoneNumber, password,\nprovince, district,\nbio, specialties,\nteachingMethods,\nyearOfExperience})
activate service

service -> db: 4. Check email exists
activate db
db --> service: Email exists or null
deactivate db

alt Email already exists
  service --> controller: BadRequestException\n"Email đã tồn tại"
else Email available
  service -> db: 5. Check phone exists
  activate db
  db --> service: Phone exists or null
  deactivate db
  
  alt Phone already exists
    service --> controller: BadRequestException\n"Số điện thoại đã tồn tại"
  else Phone available
    service -> service: 6. Hash password\nwith bcrypt
    service -> db: 7. Get coach role
    activate db
    db --> service: Coach role
    deactivate db
    
    service -> service: 8. Create user + coach\nprofile entity
    
    alt Email provided
      service -> service: 9a. Generate email\nverification token
      service -> mail: 10a. Send verification email
      mail --> service: Email sent
    end
    
    alt Phone provided
      service -> twilio: 10b. Send SMS code
      twilio --> service: SMS sent
    end
    
    service -> db: 11. Save user & coach profile\nto database
    activate db
    db --> service: User & Coach created
    deactivate db
    
    service --> controller: Register success
  end
end

deactivate service

controller --> client: 12. HTTP 201\nResponse
deactivate controller

client --> guest: 13. Show result\n(verify email/phone prompt)

@enduml
