@startuml learner-join-session
title Learner Join Session (Video Conference)

actor Learner
participant "Frontend\nApp" as Frontend
participant "API\nGateway" as API
participant "Session\nController" as SessionCtrl
participant "Session\nService" as SessionSvc
participant "Agora\nSDK" as Agora
participant "Database" as DB

== View Sessions ==
Learner -> Frontend: View course sessions
Frontend -> API: GET /courses/:courseId/sessions
API -> SessionCtrl: getSessionsByCourseId(courseId)
API -> SessionSvc: findByCourseId(courseId)
SessionSvc -> DB: Query sessions
DB --> SessionSvc: Session list
SessionSvc --> API: Sessions
API --> Frontend: Display sessions
Frontend --> Learner: Show session list & join buttons

== Get Session Details ==
Learner -> Frontend: Click "Join Session"
Frontend -> API: GET /sessions/:id
API -> SessionCtrl: getSessionById(sessionId)
SessionCtrl -> SessionSvc: findOne(sessionId)
SessionSvc -> DB: Query session details
DB --> SessionSvc: Session data (videoConferenceInfo)
SessionSvc --> SessionCtrl: Session details
SessionCtrl --> API: Session data
API --> Frontend: Session details\n(includes token, channelId)
Frontend --> Learner: Display session info

== Initialize Video Conference ==
Frontend -> Frontend: Extract video conference credentials\nfrom session data (token, channelId, uid)
Frontend -> Agora: JoinChannel(token, channelId, uid=learnerId)
Agora --> Frontend: Stream active
Frontend --> Learner: Display video conference\n(coach + other learners)

== Session In Progress ==
note right of Learner
  - Learner views coach stream
  - Real-time video/audio
  - Can see other participants
end

== Session End (Coach Initiated) ==
Learner -> Frontend: Session ends
Frontend -> Agora: LeaveChannel()
Agora --> Frontend: Channel closed

Frontend -> API: PATCH /sessions/:id/complete\n(attendanceData)
API -> SessionCtrl: completeSession(sessionId, attendanceData)
SessionCtrl -> SessionSvc: completeAndCheckAttendance(sessionId, attendanceData)
SessionSvc -> DB: Update session status\nRecord attendance for all learners
DB --> SessionSvc: Attendance recorded
SessionSvc --> SessionCtrl: Success
SessionCtrl --> API: Session completed
API --> Frontend: Success
Frontend --> Learner: Session ended\nDisplay participation summary

@enduml
