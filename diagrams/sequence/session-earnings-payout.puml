@startuml session-earnings-payout

title Session Earnings & Coach Payout

participant "Scheduler\n(Cron Job)" as Scheduler
participant "Session\nService" as SessionSvc
participant "SessionEarning\nService" as EarningSvc
participant "Wallet\nService" as WalletSvc
participant "Enrollment\nService" as EnrollmentSvc
participant "Notification\nService" as NotifSvc
participant "Database" as DB

== Session Completion Trigger ==
Scheduler -> SessionSvc: ProcessCompletedSessions()
SessionSvc -> DB: Query sessions\n(status=IN_PROGRESS, endTime <= now)
DB --> SessionSvc: Completed sessions list

loop For each completed session
    SessionSvc -> SessionSvc: Get session details\n(courseId, coachId, rate, duration)
    
    == Calculate Earnings ==
    EarningSvc -> DB: Get course enrollments\n(courseId, status=CONFIRMED|PENDING_GROUP)
    DB --> EarningSvc: Enrolled learners count
    
    EarningSvc -> EarningSvc: Calculate earnings
    
    EarningSvc -> SessionSvc: Get session final data\n(actualStartTime, actualEndTime, actualAttendance)
    SessionSvc -> DB: Query attendance logs\n(sessionId, status=PRESENT|LATE)
    DB --> SessionSvc: Attendance data
    SessionSvc --> EarningSvc: Attendance details
    
    == Create Earnings Record ==
    EarningSvc -> DB: Create SessionEarning record
    DB --> EarningSvc: SessionEarning created
    
    == Process Payment ==
    EarningSvc -> EarningSvc: Prepare wallet update\n(amount, transactionType=SESSION_EARNING)
    
    EarningSvc -> WalletSvc: CreditWallet\n(coachId, amount, sessionEarningId)
    WalletSvc -> DB: Get Wallet record\n(coachId)
    DB --> WalletSvc: Wallet data
    
    WalletSvc -> WalletSvc: Calculate new balance\nbalance = totalIncome + amount
    
    WalletSvc -> DB: Update Wallet\n(totalIncome += amount, totalBalance += amount)
    DB --> WalletSvc: Wallet updated
    
    WalletSvc -> DB: Create WalletTransaction\n(walletId, coachId, type=CREDIT,\namount, description=Session #{sessionId},\nstatus=COMPLETED, transactionDate=now)
    DB --> WalletSvc: Transaction created
    
    WalletSvc -> EarningSvc: Credit confirmed
    
    == Update Earning Status ==
    DB --> EarningSvc: SessionEarning marked paid
    
    == Session Status Update ==
    SessionSvc -> DB: Update Session\n(status=COMPLETED, completedAt=now)
    DB --> SessionSvc: Session completed
    
    == Notification ==
    EarningSvc -> NotifSvc: SendNotification\n(coachId, "Session earnings credited!")
    NotifSvc -> DB: Log notification\n(type=SESSION_EARNING_PAID,\namount, sessionId)
    DB --> NotifSvc: Notification logged
    NotifSvc --> NotifSvc: Send to coach
    
end

@enduml

