sequenceDiagram
    actor coach as Coach
    participant client as Web Browser
    participant controller as QuizController
    participant service as QuizService
    participant quizRepo as QuizRepository
    participant db as PostgreSQL

    Note over coach, db: Update Session Quiz

    coach->>client: 1. View session
    client-->>coach: 2. Display session details with quiz

    coach->>client: 3. Click "Edit Quiz"
    client-->>coach: 4. Show quiz edit form

    coach->>client: 5. Modify quiz details

    coach->>client: 6. Submit updated quiz
    client->>controller: 7. PUT /quizzes/:id
    activate controller

    controller->>controller: 8. Validate DTO

    controller->>service: 9. update(id, data, userId)
    activate service

    service->>quizRepo: 10. findOne(id, ...)
    activate quizRepo
    quizRepo->>db: Query quiz
    activate db
    db-->>quizRepo: Quiz data
    deactivate db
    quizRepo-->>service: Quiz found
    deactivate quizRepo

    service->>service: 11. Verify ownership (quiz.session.course.coach.id == currentUser)

    service->>db: 12. Start transaction
    activate db

    service->>quizRepo: 13. Remove old questions
    activate quizRepo
    quizRepo->>db: Delete questions
    deactivate quizRepo

    service->>quizRepo: 14. Insert new questions & options
    activate quizRepo
    quizRepo->>db: Insert with cascade
    deactivate quizRepo

    service->>quizRepo: 15. Update quiz metadata
    activate quizRepo
    quizRepo->>db: Update quiz
    deactivate quizRepo

    service->>db: 16. Commit transaction
    deactivate db

    service-->>controller: Success response
    deactivate service

    controller-->>client: 17. HTTP 200 OK
    deactivate controller

    client-->>coach: 18. "Quiz updated successfully"
