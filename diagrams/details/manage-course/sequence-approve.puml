@startuml ApproveCourseSequence

actor "Admin" as admin
participant "CourseController" as controller
participant "AuthGuard" as authGuard
participant "RoleGuard" as roleGuard
participant "CourseService" as service
participant "ScheduleService" as scheduleService
participant "SessionService" as sessionService
participant "NotificationService" as notificationService
database "DataSource" as db

== Approve Course Creation Request ==

admin -> controller: PATCH /courses/requests/:id/approve
activate controller

controller -> authGuard: canActivate
authGuard --> controller: authenticated

controller -> roleGuard: canActivate
roleGuard --> controller: ADMIN role

controller -> service: approveCourseCreationRequest(id)
activate service

service -> db: transaction
activate db

service -> db: find request\n(type=COURSE_CREATION,\nstatus=PENDING_APPROVAL)

service -> db: extract metadata and\ncreate Course\nstatus = APPROVED

service -> scheduleService: createSchedules(course, schedules)
activate scheduleService
scheduleService -> db: INSERT schedules
scheduleService --> service: Schedule[]
deactivate scheduleService

service -> sessionService: generateSessionsFromSchedule(course)
activate sessionService
sessionService -> db: INSERT sessions\n(based on schedules, lessons, dates)
sessionService --> service: Session[]
deactivate sessionService

service -> db: update request\nstatus = APPROVED

service -> db: create RequestAction\ntype = APPROVED

service -> notificationService: notify coach\n(course creation approved)
activate notificationService
notificationService --> service: sent
deactivate notificationService

db --> service: commit
deactivate db

service --> controller: CustomApiResponse(success)
deactivate service

controller --> admin: HTTP 200 {message}
deactivate controller

@enduml
activate controller

controller -> authGuard: canActivate(context)
activate authGuard
authGuard --> controller: true (authenticated)
deactivate authGuard

controller -> roleGuard: canActivate(context)
activate roleGuard
roleGuard --> controller: true (ADMIN role)
deactivate roleGuard

controller -> service: approveCourseCreationRequest(id)
activate service

service -> db: transaction start
activate db

service -> requestRepo: findOne(id, {relations: [createdBy]})\nWHERE type = COURSE_CREATION\nAND status = PENDING_APPROVAL
activate requestRepo
requestRepo -> db: SELECT request
db --> requestRepo: Request
requestRepo --> service: Request
deactivate requestRepo

alt request not found or already processed
    service --> controller: throw BadRequestException
    controller --> admin: HTTP 400 Error
else request valid

service -> service: extractMetadata(request.metadata)\n(name, description, level, format,\nstartDate, endDate, min/maxParticipants,\nprice, schedules, courtId, subjectId, etc.)

service -> courseRepo: create(Course)\nstatus = APPROVED\nusing metadata
activate courseRepo
courseRepo -> db: INSERT course
db --> courseRepo: Course
courseRepo --> service: Course
deactivate courseRepo

service -> scheduleService: createSchedules(course, schedules)
activate scheduleService
scheduleService -> db: INSERT schedules
db --> scheduleService: Schedule[]
scheduleService --> service: Schedule[]
deactivate scheduleService

service -> sessionService: generateSessionsFromSchedule(course)
activate sessionService
sessionService -> db: INSERT sessions\n(generate based on schedules,\nlessonCount, startDate)
db --> sessionService: Session[]
sessionService --> service: Session[]
deactivate sessionService

service -> requestRepo: update(request.id,\n{status: APPROVED, processedAt: now})
activate requestRepo
requestRepo -> db: UPDATE request
db --> requestRepo: updated
requestRepo --> service: Request
deactivate requestRepo

service -> actionRepo: create(RequestAction)\ntype=APPROVED\nactionBy=adminId
activate actionRepo
actionRepo -> db: INSERT request_action
db --> actionRepo: RequestAction
actionRepo --> service: RequestAction
deactivate actionRepo

service -> notificationService: sendNotification(coach,\ncourse_creation_approved)
activate notificationService
notificationService --> service: sent
deactivate notificationService

db --> service: commit
deactivate db

service --> controller: CustomApiResponse(success)
deactivate service

controller --> admin: HTTP 200 {message}
deactivate controller

end

@enduml
