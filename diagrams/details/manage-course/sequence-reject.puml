@startuml RejectCourseSequence

actor "Admin" as admin
participant "CourseController" as controller
participant "AuthGuard" as authGuard
participant "RoleGuard" as roleGuard
participant "CourseService" as service
participant "RequestRepository" as requestRepo
participant "RequestActionRepository" as actionRepo
participant "NotificationService" as notificationService
database "DataSource" as db

admin -> controller: PATCH /courses/requests/:id/reject\n(reason: string)
activate controller

controller -> authGuard: canActivate(context)
activate authGuard
authGuard --> controller: true (authenticated)
deactivate authGuard

controller -> roleGuard: canActivate(context)
activate roleGuard
roleGuard --> controller: true (ADMIN role)
deactivate roleGuard

controller -> service: rejectCourseCreationRequest(id, reason)
activate service

service -> db: transaction start
activate db

service -> requestRepo: findOne(id, {relations: [createdBy]})\nWHERE type = COURSE_CREATION\nAND status = PENDING_APPROVAL
activate requestRepo
requestRepo -> db: SELECT request
db --> requestRepo: Request
requestRepo --> service: Request
deactivate requestRepo

alt request not found or already processed
    service --> controller: throw BadRequestException
    controller --> admin: HTTP 400 Error
else request valid

service -> requestRepo: update(request.id,\n{status: REJECTED,\nprocessedAt: now,\nrejectionReason: reason})
activate requestRepo
requestRepo -> db: UPDATE request
db --> requestRepo: updated
requestRepo --> service: Request
deactivate requestRepo

service -> actionRepo: create(RequestAction)\ntype=REJECTED\nactionBy=adminId\nreason=reason
activate actionRepo
actionRepo -> db: INSERT request_action
db --> actionRepo: RequestAction
actionRepo --> service: RequestAction
deactivate actionRepo

service -> notificationService: sendNotification(coach,\ncourse_creation_rejected,\nreason)
activate notificationService
notificationService --> service: sent
deactivate notificationService

db --> service: commit
deactivate db

service --> controller: CustomApiResponse(success)
deactivate service

controller --> admin: HTTP 200 {message}
deactivate controller

end

@enduml
