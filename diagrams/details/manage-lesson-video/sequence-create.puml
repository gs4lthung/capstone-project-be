@startuml CreateLessonVideo

actor Coach
participant VideoController
participant AuthGuard
participant RoleGuard
participant VideoService
participant BunnyService
participant FFmpegService
participant DataSource

== Create Lesson Video ==

Coach -> VideoController: POST /videos/lessons/:id (multipart/form-data)
activate VideoController

VideoController -> AuthGuard: validate JWT
activate AuthGuard
AuthGuard --> VideoController: valid
deactivate AuthGuard

VideoController -> RoleGuard: check COACH role
activate RoleGuard
RoleGuard --> VideoController: authorized
deactivate RoleGuard

VideoController -> VideoService: createLessonVideo(lessonId, data, videoFile)
activate VideoService

VideoService -> DataSource: BEGIN TRANSACTION
activate DataSource

DataSource -> DataSource: find lesson with subject relations
DataSource -> DataSource: verify ownership (subject.createdBy == currentUser)

note right of DataSource
  Upload video file to CDN
end note

VideoService -> BunnyService: uploadVideo(videoFile)
activate BunnyService
BunnyService --> VideoService: publicUrl, thumbnailUrl
deactivate BunnyService

VideoService -> FFmpegService: extractMetadata(videoFile)
activate FFmpegService
FFmpegService --> VideoService: duration, resolution
deactivate FFmpegService

DataSource -> DataSource: create video with PENDING status
DataSource -> DataSource: COMMIT

DataSource --> VideoService: success
deactivate DataSource

VideoService --> VideoController: CustomApiResponse (CREATED)
deactivate VideoService

VideoController --> Coach: HTTP 201 created
deactivate VideoController

== Create Session Video ==

Coach -> VideoController: POST /videos/sessions/:id (multipart/form-data)
activate VideoController

VideoController -> AuthGuard: validate JWT
activate AuthGuard
AuthGuard --> VideoController: valid
deactivate AuthGuard

VideoController -> RoleGuard: check COACH role
activate RoleGuard
RoleGuard --> VideoController: authorized
deactivate RoleGuard

VideoController -> VideoService: createSessionVideo(sessionId, data, videoFile)
activate VideoService

VideoService -> DataSource: BEGIN TRANSACTION
activate DataSource

DataSource -> DataSource: find session with course relations
DataSource -> DataSource: verify ownership (course.createdBy == currentUser)

VideoService -> BunnyService: uploadVideo(videoFile)
activate BunnyService
BunnyService --> VideoService: publicUrl, thumbnailUrl
deactivate BunnyService

VideoService -> FFmpegService: extractMetadata(videoFile)
activate FFmpegService
FFmpegService --> VideoService: duration, resolution
deactivate FFmpegService

DataSource -> DataSource: create video with PENDING status
DataSource -> DataSource: COMMIT

DataSource --> VideoService: success
deactivate DataSource

VideoService --> VideoController: CustomApiResponse (CREATED)
deactivate VideoService

VideoController --> Coach: HTTP 201 created
deactivate VideoController

@enduml
