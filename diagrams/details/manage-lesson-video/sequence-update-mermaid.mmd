sequenceDiagram
    actor coach as Coach
    participant controller as VideoController
    participant auth as AuthGuard
    participant role as RoleGuard
    participant service as VideoService
    participant bunny as BunnyService
    participant ffmpeg as FFmpegService
    participant db as DataSource

    coach->>controller: PUT /videos/:id (optional multipart/form-data)
    activate controller

    controller->>auth: validate JWT
    activate auth
    auth-->>controller: valid
    deactivate auth

    controller->>role: check COACH role
    activate role
    role-->>controller: authorized
    deactivate role

    controller->>service: updateVideo(id, data, videoFile?)
    activate service

    service->>db: BEGIN TRANSACTION
    activate db

    db->>db: find video with lesson/subject relations
    db->>db: verify is lesson video (not session video)
    db->>db: verify ownership (subject.createdBy == currentUser)

    alt video file provided
        service->>bunny: deleteVideo(oldUrl)
        activate bunny
        bunny-->>service: deleted
        deactivate bunny
        
        service->>bunny: uploadVideo(newVideoFile)
        activate bunny
        bunny-->>service: publicUrl, thumbnailUrl
        deactivate bunny
        
        service->>ffmpeg: extractMetadata(newVideoFile)
        activate ffmpeg
        ffmpeg-->>service: duration, resolution
        deactivate ffmpeg
    end

    db->>db: update video record
    db->>db: COMMIT

    db-->>service: success
    deactivate db

    service-->>controller: CustomApiResponse (OK)
    deactivate service

    controller-->>coach: HTTP 200 updated
    deactivate controller
