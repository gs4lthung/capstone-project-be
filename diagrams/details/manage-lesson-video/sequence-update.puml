@startuml UpdateLessonVideo

actor Coach
participant VideoController
participant AuthGuard
participant RoleGuard
participant VideoService
participant BunnyService
participant FFmpegService
participant DataSource

Coach -> VideoController: PUT /videos/:id (optional multipart/form-data)
activate VideoController

VideoController -> AuthGuard: validate JWT
activate AuthGuard
AuthGuard --> VideoController: valid
deactivate AuthGuard

VideoController -> RoleGuard: check COACH role
activate RoleGuard
RoleGuard --> VideoController: authorized
deactivate RoleGuard

VideoController -> VideoService: updateVideo(id, data, videoFile?)
activate VideoService

VideoService -> DataSource: BEGIN TRANSACTION
activate DataSource

DataSource -> DataSource: find video with lesson/subject relations
DataSource -> DataSource: verify is lesson video (not session video)
DataSource -> DataSource: verify ownership (subject.createdBy == currentUser)

alt video file provided
    VideoService -> BunnyService: deleteVideo(oldUrl)
    activate BunnyService
    BunnyService --> VideoService: deleted
    deactivate BunnyService
    
    VideoService -> BunnyService: uploadVideo(newVideoFile)
    activate BunnyService
    BunnyService --> VideoService: publicUrl, thumbnailUrl
    deactivate BunnyService
    
    VideoService -> FFmpegService: extractMetadata(newVideoFile)
    activate FFmpegService
    FFmpegService --> VideoService: duration, resolution
    deactivate FFmpegService
end

DataSource -> DataSource: update video record
DataSource -> DataSource: COMMIT

DataSource --> VideoService: success
deactivate DataSource

VideoService --> VideoController: CustomApiResponse (OK)
deactivate VideoService

VideoController --> Coach: HTTP 200 updated
deactivate VideoController

@enduml
