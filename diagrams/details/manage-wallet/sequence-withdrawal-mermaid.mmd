sequenceDiagram
    actor User
    participant controller as WalletController
    participant auth as AuthGuard
    participant service as WalletService
    participant db as DataSource

    User->>controller: POST /wallets/withdrawal
    activate controller

    controller->>auth: validate JWT
    activate auth
    auth-->>controller: valid
    deactivate auth

    controller->>service: handleWithdrawalRequest(amount)
    activate service

    service->>db: BEGIN TRANSACTION
    activate db

    db->>db: find user's wallet
    db->>db: verify wallet exists
    db->>db: verify sufficient balance
    db->>db: calculate new balance (current - amount)
    db->>db: update wallet currentBalance
    db->>db: create WalletTransaction (DEBIT)
    db->>db: COMMIT

    Note right of db: Transaction flow:<br/>1. Find wallet by userId<br/>2. Check: amount <= currentBalance<br/>3. Deduct: currentBalance -= amount<br/>4. Create DEBIT transaction

    db-->>service: success
    deactivate db

    service-->>controller: CustomApiResponse (200)
    deactivate service

    controller-->>User: HTTP 200 OK (withdrawal success)
    deactivate controller
