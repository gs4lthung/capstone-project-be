@startuml ManageSubjectCRUDDiagram

actor Coach
participant AuthGuard
participant RoleGuard
participant SubjectController
participant SubjectService
participant BunnyService
database DataSource

== Create Subject ==

Coach -> SubjectController: POST /subjects (name, description, level, file)
activate SubjectController

SubjectController -> AuthGuard: validate token
activate AuthGuard
AuthGuard --> SubjectController: valid
deactivate AuthGuard

SubjectController -> RoleGuard: check COACH role
activate RoleGuard
RoleGuard --> SubjectController: authorized
deactivate RoleGuard

SubjectController -> SubjectService: create(data, file)
activate SubjectService

alt File provided
  SubjectService -> BunnyService: uploadToStorage(file)
  activate BunnyService
  BunnyService --> SubjectService: publicUrl
  deactivate BunnyService
end

SubjectService -> DataSource: INSERT subject (status=DRAFT)
activate DataSource
DataSource --> SubjectService: created
deactivate DataSource

SubjectService --> SubjectController: success
deactivate SubjectService

SubjectController --> Coach: 201 Created
deactivate SubjectController

== View All Subjects ==

Coach -> SubjectController: GET /subjects?page=1&limit=10
activate SubjectController

SubjectController -> AuthGuard: validate token
activate AuthGuard
AuthGuard --> SubjectController: valid
deactivate AuthGuard

SubjectController -> RoleGuard: check COACH role
activate RoleGuard
RoleGuard --> SubjectController: authorized
deactivate RoleGuard

SubjectController -> SubjectService: findAll(options)
activate SubjectService

SubjectService -> DataSource: SELECT subjects with pagination
activate DataSource
DataSource --> SubjectService: subjects list
deactivate DataSource

SubjectService --> SubjectController: paginated results
deactivate SubjectService

SubjectController --> Coach: 200 OK
deactivate SubjectController

== View Subject Details ==

Coach -> SubjectController: GET /subjects/:id
activate SubjectController

SubjectController -> AuthGuard: validate token
activate AuthGuard
AuthGuard --> SubjectController: valid
deactivate AuthGuard

SubjectController -> RoleGuard: check COACH role
activate RoleGuard
RoleGuard --> SubjectController: authorized
deactivate RoleGuard

SubjectController -> SubjectService: findOne(id)
activate SubjectService

SubjectService -> DataSource: SELECT subject with relations
activate DataSource
DataSource --> SubjectService: subject data
deactivate DataSource

SubjectService --> SubjectController: subject
deactivate SubjectService

SubjectController --> Coach: 200 OK
deactivate SubjectController

== Update Subject ==

Coach -> SubjectController: PUT /subjects/:id (data)
activate SubjectController

SubjectController -> AuthGuard: validate token
activate AuthGuard
AuthGuard --> SubjectController: valid
deactivate AuthGuard

SubjectController -> RoleGuard: check COACH role
activate RoleGuard
RoleGuard --> SubjectController: authorized
deactivate RoleGuard

SubjectController -> SubjectService: update(id, data)
activate SubjectService

SubjectService -> DataSource: SELECT subject with lessons
activate DataSource
DataSource --> SubjectService: subject found
deactivate DataSource

SubjectService -> SubjectService: verify ownership

alt Status change to PUBLISHED
  SubjectService -> DataSource: SELECT lessons for validation
  activate DataSource
  DataSource --> SubjectService: lessons
  deactivate DataSource
  
  SubjectService -> SubjectService: validate all lessons have video & quiz
end

SubjectService -> DataSource: UPDATE subject
activate DataSource
DataSource --> SubjectService: updated
deactivate DataSource

SubjectService --> SubjectController: success
deactivate SubjectService

SubjectController --> Coach: 200 OK
deactivate SubjectController

@enduml
